name: Provider Conformance

on:
  pull_request:
  push:
    branches: [ main ]
  workflow_dispatch:
  schedule:
    - cron: "0 3 * * *"

permissions:
  contents: read

concurrency:
  group: provider-conformance-${{ github.ref }}
  cancel-in-progress: true

jobs:
  k8s_kind:
    strategy:
      fail-fast: false
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Cache cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}-k8s-kind
          restore-keys: ${{ runner.os }}-cargo-

      - name: Set up Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: wasm32-wasip2

      - name: Create kind cluster
        uses: helm/kind-action@v1
        with:
          version: v0.23.0

      - name: Install kubectl
        uses: azure/setup-kubectl@v4

      - name: Prepare k8s credentials
        run: |
          set -euo pipefail
          kubectl create serviceaccount greentic-sa -n default
          kubectl create clusterrolebinding greentic-sa --clusterrole=cluster-admin --serviceaccount=default:greentic-sa
          TOKEN=$(kubectl create token greentic-sa)
          SERVER=$(kubectl config view --minify -o jsonpath='{.clusters[0].cluster.server}')
          CA_PATH=$(mktemp)
          kubectl config view --minify --raw --flatten -o jsonpath='{.clusters[0].cluster.certificate-authority-data}' | base64 -d > "$CA_PATH"
          echo "K8S_BEARER_TOKEN=$TOKEN" >> $GITHUB_ENV
          echo "K8S_API_SERVER=$SERVER" >> $GITHUB_ENV
          echo "K8S_CA_BUNDLE=$CA_PATH" >> $GITHUB_ENV
          echo "K8S_NAMESPACE_PREFIX=greentic" >> $GITHUB_ENV
          echo "K8S_KEK_ALIAS=default" >> $GITHUB_ENV

      - name: Wait for nodes Ready
        run: kubectl wait --for=condition=Ready nodes --all --timeout=60s

      - name: Run k8s provider conformance
        env:
          GREENTIC_INTEGRATION: "1"
          GREENTIC_TEST_PREFIX: ci/k8s/${{ github.run_id }}/${{ github.run_attempt }}
        run: cargo test -p secrets-provider-k8s --features integration -- --ignored --nocapture

      - name: Debug cluster state on failure
        if: failure()
        run: |
          kubectl get all -A || true
          kubectl describe pods -A || true

  vault_dev:
    strategy:
      fail-fast: false
    runs-on: ubuntu-latest
    services:
      vault:
        image: hashicorp/vault:1.17
        env:
          VAULT_DEV_ROOT_TOKEN_ID: root
        ports:
          - 8200:8200
        options: >-
          --health-cmd="vault status || exit 1" --health-interval=5s --health-retries=20
    steps:
      - uses: actions/checkout@v4

      - name: Cache cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}-vault
          restore-keys: ${{ runner.os }}-cargo-

      - name: Set up Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Wait for Vault
        run: |
          for i in {1..30}; do
            if curl -sf http://127.0.0.1:8200/v1/sys/health; then exit 0; fi
            sleep 2
          done
          exit 1

      - name: Configure Vault mounts
        env:
          VAULT_ADDR: http://127.0.0.1:8200
          VAULT_TOKEN: root
        run: |
          set -euo pipefail
          curl -sf -X POST -H "X-Vault-Token: $VAULT_TOKEN" \
            -d '{"type":"transit"}' "$VAULT_ADDR/v1/sys/mounts/transit" || true
          curl -sf -X POST -H "X-Vault-Token: $VAULT_TOKEN" "$VAULT_ADDR/v1/transit/keys/greentic" || true

      - name: Run vault provider conformance
        env:
          VAULT_ADDR: http://127.0.0.1:8200
          VAULT_TOKEN: root
          GREENTIC_INTEGRATION: "1"
          GREENTIC_TEST_PREFIX: ci/vault/${{ github.run_id }}/${{ github.run_attempt }}
        run: cargo test -p secrets-provider-vault-kv --features integration -- --ignored --nocapture

      - name: Vault logs on failure
        if: failure()
        run: |
          docker ps -a
          docker logs $(docker ps -aq --filter "ancestor=hashicorp/vault:1.17") || true

  aws_localstack:
    strategy:
      fail-fast: false
    runs-on: ubuntu-latest
    services:
      localstack:
        image: localstack/localstack:3
        ports:
          - 4566:4566
        env:
          SERVICES: "secretsmanager,kms"
        options: >-
          --health-cmd="awslocal sts get-caller-identity || exit 1"
          --health-interval=5s --health-retries=20
    steps:
      - uses: actions/checkout@v4

      - name: Cache cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}-aws-localstack
          restore-keys: ${{ runner.os }}-cargo-

      - name: Set up Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Wait for LocalStack
        run: |
          for i in {1..30}; do
            if curl -sf http://127.0.0.1:4566/health; then exit 0; fi
            sleep 2
          done
          exit 1

      - name: Run AWS provider conformance (LocalStack)
        env:
          AWS_ACCESS_KEY_ID: test
          AWS_SECRET_ACCESS_KEY: test
          AWS_REGION: us-east-1
          AWS_ENDPOINT_URL: http://127.0.0.1:4566
          GREENTIC_INTEGRATION: "1"
          GREENTIC_TEST_PREFIX: ci/aws-localstack/${{ github.run_id }}/${{ github.run_attempt }}
        run: cargo test -p secrets-provider-aws-sm --features integration -- --ignored --nocapture

      - name: LocalStack logs on failure
        if: failure()
        run: docker logs $(docker ps -aq --filter "ancestor=localstack/localstack:3") || true

  aws_real:
    if: github.event_name != 'pull_request' && (github.event_name == 'schedule' || github.event_name == 'workflow_dispatch')
    strategy:
      fail-fast: false
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
    steps:
      - uses: actions/checkout@v4

      - name: Cache cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}-aws-real
          restore-keys: ${{ runner.os }}-cargo-

      - name: Set up Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ vars.AWS_ROLE_TO_ASSUME }}
          aws-region: ${{ vars.AWS_REGION }}
        if: ${{ vars.AWS_ROLE_TO_ASSUME != '' && vars.AWS_REGION != '' }}

      - name: Fail if AWS vars missing
        if: ${{ vars.AWS_ROLE_TO_ASSUME == '' || vars.AWS_REGION == '' }}
        run: |
          echo "AWS_ROLE_TO_ASSUME and AWS_REGION must be set as GitHub variables." >&2
          exit 1

      - name: Run AWS provider conformance (real)
        env:
          AWS_REGION: ${{ vars.AWS_REGION }}
          GREENTIC_INTEGRATION: "1"
          GREENTIC_TEST_PREFIX: ci/aws/${{ github.run_id }}/${{ github.run_attempt }}
        run: cargo test -p secrets-provider-aws-sm --features integration -- --ignored --nocapture

  azure_real:
    if: github.event_name != 'pull_request' && (github.event_name == 'schedule' || github.event_name == 'workflow_dispatch')
    strategy:
      fail-fast: false
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
    steps:
      - uses: actions/checkout@v4

      - name: Cache cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}-azure
          restore-keys: ${{ runner.os }}-cargo-

      - name: Set up Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Azure login (OIDC)
        uses: azure/login@v2
        with:
          client-id: ${{ vars.AZURE_CLIENT_ID }}
          tenant-id: ${{ vars.AZURE_TENANT_ID }}
          subscription-id: ${{ vars.AZURE_SUBSCRIPTION_ID }}
        if: ${{ vars.AZURE_CLIENT_ID != '' && vars.AZURE_TENANT_ID != '' && vars.AZURE_SUBSCRIPTION_ID != '' && vars.AZURE_KEYVAULT_NAME != '' }}

      - name: Fail if Azure vars missing
        if: ${{ vars.AZURE_CLIENT_ID == '' || vars.AZURE_TENANT_ID == '' || vars.AZURE_SUBSCRIPTION_ID == '' || vars.AZURE_KEYVAULT_NAME == '' }}
        run: |
          echo "AZURE_CLIENT_ID, AZURE_TENANT_ID, AZURE_SUBSCRIPTION_ID, AZURE_KEYVAULT_NAME must be set as GitHub variables." >&2
          exit 1

      - name: Prepare Key Vault
        env:
          AZURE_KEYVAULT_NAME: ${{ vars.AZURE_KEYVAULT_NAME }}
        run: |
          set -euo pipefail
          export AZURE_KEYVAULT_URL="https://${AZURE_KEYVAULT_NAME}.vault.azure.net"
          KEY_NAME="greentic-conformance"
          if ! az keyvault key show --vault-name "$AZURE_KEYVAULT_NAME" --name "$KEY_NAME" >/dev/null 2>&1; then
            az keyvault key create --vault-name "$AZURE_KEYVAULT_NAME" --name "$KEY_NAME" --kty RSA > /dev/null
          fi
          token=$(az account get-access-token --resource https://vault.azure.net --query accessToken -o tsv)
          echo "::add-mask::$token"
          {
            echo "AZURE_KEYVAULT_URL=$AZURE_KEYVAULT_URL"
            echo "GREENTIC_AZURE_KEY_NAME=$KEY_NAME"
            echo "AZURE_KEYVAULT_BEARER_TOKEN=$token"
          } >> "$GITHUB_ENV"

      - name: Run Azure provider conformance
        env:
          GREENTIC_INTEGRATION: "1"
          GREENTIC_TEST_PREFIX: ci/azure/${{ github.run_id }}/${{ github.run_attempt }}
          GREENTIC_REQUIRE_AZURE: "1"
          AZURE_KEYVAULT_URL: ${{ env.AZURE_KEYVAULT_URL }}
          GREENTIC_AZURE_KEY_NAME: ${{ env.GREENTIC_AZURE_KEY_NAME }}
          AZURE_KEYVAULT_BEARER_TOKEN: ${{ env.AZURE_KEYVAULT_BEARER_TOKEN }}
          GREENTIC_AZURE_BEARER_TOKEN: ${{ env.AZURE_KEYVAULT_BEARER_TOKEN }}
          AZURE_CLIENT_ID: ${{ vars.AZURE_CLIENT_ID }}
          AZURE_TENANT_ID: ${{ vars.AZURE_TENANT_ID }}
        run: cargo test -p secrets-provider-azure-kv --features integration -- --ignored --nocapture

  gcp_real:
    if: github.event_name != 'pull_request' && (github.event_name == 'schedule' || github.event_name == 'workflow_dispatch')
    strategy:
      fail-fast: false
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
    steps:
      - uses: actions/checkout@v4

      - name: Cache cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}-gcp
          restore-keys: ${{ runner.os }}-cargo-

      - name: Set up Rust
        uses: dtolnay/rust-toolchain@stable

      - id: auth
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ vars.GCP_WIF_PROVIDER }}
          service_account: ${{ vars.GCP_SERVICE_ACCOUNT }}
        if: ${{ vars.GCP_WIF_PROVIDER != '' && vars.GCP_SERVICE_ACCOUNT != '' && vars.GCP_PROJECT_ID != '' }}

      - name: Fail if GCP vars missing
        if: ${{ vars.GCP_WIF_PROVIDER == '' || vars.GCP_SERVICE_ACCOUNT == '' || vars.GCP_PROJECT_ID == '' }}
        run: |
          echo "GCP_WIF_PROVIDER, GCP_SERVICE_ACCOUNT, and GCP_PROJECT_ID must be set as GitHub variables." >&2
          exit 1

      - name: Setup gcloud (optional)
        uses: google-github-actions/setup-gcloud@v2
        with:
          install_components: beta
          project_id: ${{ vars.GCP_PROJECT_ID }}

      - name: Run GCP provider conformance
        env:
          GCP_PROJECT_ID: ${{ vars.GCP_PROJECT_ID }}
          GREENTIC_INTEGRATION: "1"
          GREENTIC_TEST_PREFIX: ci/gcp/${{ github.run_id }}/${{ github.run_attempt }}
        run: cargo test -p secrets-provider-gcp-sm --features integration -- --ignored --nocapture
