name: CI
on: [push, pull_request]
permissions:
  contents: read
jobs:
  fast:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - run: cargo build --workspace --all-features
      - run: RUST_BACKTRACE=1 cargo test --workspace --all-features -- --nocapture
      - name: Deny reqwest::blocking in Vault provider
        run: |
          if git grep -n "reqwest::blocking" -- providers/greentic-vault-kv >/dev/null; then
            echo "Do not use reqwest::blocking (causes runtime panics)" >&2
            exit 1
          fi

  local-providers:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        provider: [dev, k8s, vault]
      fail-fast: false
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable

      - if: matrix.provider == 'k8s'
        name: Start KinD
        uses: helm/kind-action@v1

      - if: matrix.provider == 'vault'
        name: Start Vault dev
        run: |
          docker run -d --name vault -e VAULT_DEV_ROOT_TOKEN_ID=root -p 8200:8200 hashicorp/vault:1.16
          echo "VAULT_ADDR=http://127.0.0.1:8200" >> $GITHUB_ENV
          echo "VAULT_TOKEN=root" >> $GITHUB_ENV
          for i in {1..20}; do curl -fsS $VAULT_ADDR/v1/sys/health && break || sleep 1; done

      - name: Conformance
        continue-on-error: true
        run: |
          case "${{ matrix.provider }}" in
            dev)   RUST_BACKTRACE=1 cargo run -p greentic-secrets-conformance --features provider-dev ;;
            k8s)   RUST_BACKTRACE=1 cargo run -p greentic-secrets-conformance --features provider-k8s ;;
            vault) RUST_BACKTRACE=1 cargo run -p greentic-secrets-conformance --features provider-vault ;;
          esac

      - name: Mark overall provider result
        if: failure()
        run: |
          echo "local provider '${{ matrix.provider }}' failed" >&2
          exit 1
