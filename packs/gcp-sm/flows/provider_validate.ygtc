schema_version: 1
id: provider_validate
type: event
entrypoints:
  default: {}
nodes:
  validate_config:
    telemetry:
      span: provider.validate.config
    operation: validate_config
    component.exec:
      config: ${inputs.config}
      schema_ref: assets/schemas/secrets/gcp-sm/config.schema.json
      component: greentic.secrets.policy_validator
  health_check:
    after: validate_config
    telemetry:
      span: provider.validate.health
    output:
      validation_report: ${data.report}
    operation: health_check
    component.exec:
      config: ${inputs.config}
      component: greentic.secrets.provider.gcp_sm
  audit:
    after: health_check
    telemetry:
      span: provider.validate.audit
    operation: emit_event
    component.exec:
      sink: ${inputs.config.audit}
      event:
        kind: PROVIDER_VALIDATED
        provider: greentic.secrets.gcp-sm
        status: ${health_check.output.validation_report.status}
        correlation_id: ${inputs.correlation_id}
        report_ref: validation_report.json
      component: greentic.secrets.audit_exporter
outputs:
  status: ${health_check.output.validation_report.status}
  provider:
    id: greentic.secrets.gcp-sm
    version: ${context.pack_version}
    tenant: ${inputs.config.tenant_id}
    environment: ${inputs.config.environment}
  correlation_id: ${inputs.correlation_id}
  audit_events:
  - ${audit.input.event}
  artifacts:
  - path: validation_report.json
    content: ${health_check.output.validation_report}
