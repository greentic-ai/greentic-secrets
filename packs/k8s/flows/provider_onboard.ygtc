schema_version: 1
id: provider_onboard
type: event
entrypoints:
  default: {}
nodes:
  validate_config:
    telemetry:
      span: provider.onboard.validate_config
    operation: validate_config
    component.exec:
      config: ${inputs.config}
      schema_ref: assets/schema/config.schema.json
      component: greentic.secrets.policy_validator
  auth:
    after: validate_config
    telemetry:
      span: provider.onboard.auth
    operation: acquire_identity
    component.exec:
      config: ${inputs.config}
      secrets: ${inputs.secrets}
      component: greentic.secrets.provider.k8s
  connectivity:
    after: auth
    telemetry:
      span: provider.onboard.connectivity
    operation: connectivity_test
    component.exec:
      config: ${inputs.config}
      component: greentic.secrets.provider.k8s
  permissions:
    after: connectivity
    telemetry:
      span: provider.onboard.permissions
    operation: permissions_test
    component.exec:
      config: ${inputs.config}
      component: greentic.secrets.provider.k8s
  ensure_namespace:
    after: permissions
    telemetry:
      span: provider.onboard.ensure_namespace
    operation: ensure_namespace
    component.exec:
      config: ${inputs.config}
      component: greentic.secrets.provider.k8s
  registration:
    after: ensure_namespace
    telemetry:
      span: provider.onboard.registration
    output:
      registration_id: ${data.registration_id}
    operation: record_registration
    component.exec:
      config: ${inputs.config}
      capabilities:
        rotate: true
        versioning: true
        tags: true
      component: greentic.secrets.provider.k8s
  audit:
    after: registration
    telemetry:
      span: provider.onboard.audit
    operation: emit_event
    component.exec:
      sink: ${inputs.config.audit}
      event:
        kind: PROVIDER_ONBOARDED
        provider: greentic.secrets.k8s
        status: READY
        registration_id: ${registration.output.registration_id}
        correlation_id: ${inputs.correlation_id}
      component: greentic.secrets.audit_exporter
outputs:
  status: OK
  provider:
    id: greentic.secrets.k8s
    version: ${context.pack_version}
    tenant: ${inputs.config.tenant_id}
    environment: ${inputs.config.environment}
  correlation_id: ${inputs.correlation_id}
  registration_id: ${registration.output.registration_id}
  capabilities:
    rotate: true
    versioning: true
    tags: true
  audit_events:
  - ${audit.input.event}
  artifacts: []
