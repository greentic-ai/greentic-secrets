PR-03.md — AWS Secrets Manager tests: LocalStack on PR + real AWS nightly via GitHub OIDC
Title

greentic-secrets: AWS Secrets Manager integration tests (LocalStack PR + real AWS nightly OIDC)

Goal

Test AWS provider in two modes:

PR / push: LocalStack (fast, no credentials)

Nightly / manual: real AWS via GitHub OIDC (true end-to-end)

Repo changes
A) Provider crate test wiring

In secrets-provider-aws-sm:

Add dev-dependency on secrets-provider-tests

Add tests/conformance.rs:

Build AWS client from env

If AWS_ENDPOINT_URL is set → localstack mode

Else → real aws mode

Feature flags:

integration

localstack (optional; only if you need endpoint-specific dependencies)

real-aws (optional; mostly just semantic)

Env vars:

AWS_REGION (required)

AWS_ENDPOINT_URL (optional)

GREENTIC_TEST_PREFIX (optional)

Do NOT print credentials

B) Workflow: aws_localstack job

Add job to secrets-providers.yml:

services: localstack/localstack

expose port 4566

health check

run tests with:

AWS_ACCESS_KEY_ID=test

AWS_SECRET_ACCESS_KEY=test

AWS_REGION=us-east-1

AWS_ENDPOINT_URL=http://127.0.0.1:4566

GREENTIC_INTEGRATION=1

cargo test -p secrets-provider-aws-sm --features integration -- --ignored --nocapture

C) Workflow: aws_real job (nightly + manual)

Add job gated by:

if: github.event_name != 'pull_request' && (github.event_name == 'schedule' || github.event_name == 'workflow_dispatch')

Permissions:

id-token: write

contents: read

Step:

aws-actions/configure-aws-credentials@v4 with role-to-assume

Env:

AWS_REGION (from repo var)

GREENTIC_TEST_PREFIX=ci/aws/${{ github.run_id }}/${{ github.run_attempt }}

Run tests:

cargo test -p secrets-provider-aws-sm --features integration -- --ignored --nocapture

D) Cleanup policy

Tests must delete all created secrets.
Additionally, add a safety cleanup step (best-effort) that lists secrets by prefix and deletes them (optional).

Docs

Add docs/ci/aws-oidc.md with:

Required IAM Role trust policy for GitHub OIDC

Minimal permissions:

secretsmanager:CreateSecret

secretsmanager:PutSecretValue

secretsmanager:GetSecretValue

secretsmanager:DeleteSecret

secretsmanager:ListSecrets (optional for cleanup)

Restrict to prefix ci/aws/* or tag-based constraint

Acceptance criteria

PRs run AWS LocalStack job and pass

Nightly job passes against real AWS when configured

No static AWS keys stored in repo secrets
