PR-01.md â€” Add provider conformance test harness (shared contract)
Title

greentic-secrets: add shared provider conformance tests + unified env contract

Goal

Create a single integration-test harness that validates the same behavior across all providers:

put secret

get secret

update/overwrite secret

delete secret

(optional) list / metadata if supported

Must be deterministic, parallel-safe, and clean up secrets reliably.

Scope

Add a new crate (or module) secrets-provider-tests (preferred) or tests/common module shared by provider crates.

Add standardized env vars and helper utilities.

Add integration feature and #[ignore] gating where needed.

Requirements

Test prefixing & uniqueness

Every test run uses unique prefix:

default: ci/<provider>/<repo>/<run_id>/<attempt>/...

local fallback: local/<timestamp>/<pid>/...

Derive from env:

GREENTIC_TEST_PREFIX (optional override)

GITHUB_RUN_ID, GITHUB_RUN_ATTEMPT, GITHUB_REPOSITORY

Cleanup always

Default cleanup enabled in CI.

Env:

GREENTIC_TEST_CLEANUP=1 (default true in CI)

GREENTIC_TEST_KEEP=1 overrides cleanup

Backoff / eventual consistency

Provide retry(fn, max_attempts, base_delay_ms) helper.

Apply to read-after-write and delete-confirmation where cloud APIs are eventually consistent.

Provider capability flags

Some providers may not implement list, metadata, versions, etc.

Use a Capabilities struct to skip optional tests cleanly.

Deliverables
A) New test harness crate (preferred)

Create crates/secrets-provider-tests/ with:

lib.rs

TestEnv parsing

TestPrefix

retry helper

ConformanceSuite runner

contract.rs

trait ProviderUnderTest:

put(key, value) -> Result<()>

get(key) -> Result<Option<Vec<u8>>>

delete(key) -> Result<()>

optional list(prefix) -> Result<Vec<String>>

assertions.rs

assert_get_eq

assert_deleted

fixtures.rs

random payload generation (small + larger payload)

capabilities.rs

B) Standard env contract

Document in crates/secrets-provider-tests/README.md:

GREENTIC_TEST_PREFIX

GREENTIC_TEST_CLEANUP

GREENTIC_TEST_KEEP

provider-specific env vars (defined in each provider PR)

C) Wire into each provider crate

Each provider crate adds:

dev-dependencies on secrets-provider-tests

a tests/conformance.rs that instantiates provider client and runs ConformanceSuite::run(...)

#[cfg(feature="integration")] for integration tests

#[ignore] unless GREENTIC_INTEGRATION=1 (or run via workflow with -- --ignored)

Acceptance criteria

cargo test -p secrets-provider-tests runs unit-only tests (no network)

Each provider has cargo test -p <provider> --features integration -- --ignored runnable with correct env

Tests are parallel-safe (no shared secret keys)

Codex instructions

Do not ask for permission to create files; create them.

Add minimal docs.

Add at least one unit test for prefix generation.

Make failures readable (include provider name + secret key in errors, but never print secret values).
