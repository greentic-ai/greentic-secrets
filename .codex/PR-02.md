PR-02.md â€” K8s + Vault integration tests + GitHub Actions (PR-gated, fully real)
Title

greentic-secrets: real CI integration tests for k8s (kind) + vault (dev server)

Goal

Add GitHub Actions jobs that run on pull_request and validate:

K8s provider against a real kind cluster

Vault provider against a real vault dev server container

Scope

Add .github/workflows/secrets-providers.yml

Add job k8s_kind and vault_dev

Ensure provider tests use secrets-provider-tests harness from PR-01

Steps
A) Add workflow skeleton

Create .github/workflows/secrets-providers.yml:

triggers:

pull_request

push (main)

workflow_dispatch

schedule nightly (for later jobs too)

B) Job: k8s_kind

Use helm/kind-action@v1 to create cluster

Install kubectl

Export KUBECONFIG

Run:

cargo test -p secrets-provider-k8s --features integration -- --ignored --nocapture

Env:

GREENTIC_INTEGRATION=1

GREENTIC_TEST_PREFIX=ci/k8s/${{ github.run_id }}/${{ github.run_attempt }}

Also:

If provider requires CRDs/namespace/serviceaccount, create them in steps.

Add kubectl get pods -A on failure for debugging.

C) Job: vault_dev

Use services: with hashicorp/vault image

Configure dev token root

Run:

cargo test -p secrets-provider-vault --features integration -- --ignored --nocapture

Env:

VAULT_ADDR=http://127.0.0.1:8200

VAULT_TOKEN=root

GREENTIC_INTEGRATION=1

GREENTIC_TEST_PREFIX=ci/vault/${{ github.run_id }}/${{ github.run_attempt }}

D) Make tests reliable

Ensure vault is ready (health check curl)

Ensure kind is ready (kubectl wait for nodes Ready)

Acceptance criteria

PR runs two new required checks: k8s_kind, vault_dev

Both jobs create secrets, read, overwrite, delete, and verify deletion

Notes

No static credentials required
