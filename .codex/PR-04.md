PR-04.md â€” Azure Key Vault tests: real Azure nightly via federated credentials
Title

greentic-secrets: Azure Key Vault integration tests via GitHub OIDC (nightly/manual)

Goal

Run Azure KV provider tests against a real Key Vault securely using GitHub federated identity (no client secret).

Repo changes
A) Provider test wiring

In secrets-provider-azure-kv:

Add dev-dependency on secrets-provider-tests

Add tests/conformance.rs:

Authenticate using DefaultAzureCredential or explicitly via env from azure/login

Use vault name from env: AZURE_KEYVAULT_NAME

Feature flags:

integration

real-azure (optional label)

Env contract:

AZURE_KEYVAULT_NAME required

AZURE_TENANT_ID, AZURE_CLIENT_ID may be available but prefer token from azure/login

GREENTIC_TEST_PREFIX for secret naming

B) Workflow job azure_real

In .github/workflows/secrets-providers.yml:

Trigger: schedule + workflow_dispatch (not PR)

Permissions:

id-token: write

contents: read

Steps:

azure/login@v2 with:

client-id, tenant-id, subscription-id from repo secrets/vars

Run:

cargo test -p secrets-provider-azure-kv --features integration -- --ignored --nocapture

C) Cleanup + naming constraints

Azure KV secret names have restrictions; ensure the prefix converts safely:

replace / with -

lowercase

keep under length limit

Implement sanitize_key() helper in shared harness or provider test

Docs

Add docs/ci/azure-oidc.md describing:

Entra App Registration

Federated credential configuration bound to repo/environment

Key Vault RBAC assignment (least privilege)

Required workflow secrets/vars:

AZURE_CLIENT_ID

AZURE_TENANT_ID

AZURE_SUBSCRIPTION_ID

AZURE_KEYVAULT_NAME

Acceptance criteria

azure_real job runs and passes in nightly/manual

No static Azure client secrets in GitHub
