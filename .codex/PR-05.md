PR-05.md — GCP Secret Manager tests: real GCP nightly via Workload Identity Federation
Title

greentic-secrets: GCP Secret Manager integration tests via GitHub Workload Identity Federation

Goal

Run GCP provider tests against a real GCP project using WIF (no JSON key file).

Repo changes
A) Provider test wiring

In secrets-provider-gcp-sm:

Add dev-dependency on secrets-provider-tests

Add tests/conformance.rs:

Use ADC credentials (provided by google-github-actions/auth)

Use env:

GCP_PROJECT_ID

Feature flags:

integration

real-gcp (optional)

B) Workflow job gcp_real

In .github/workflows/secrets-providers.yml:

Trigger: schedule + workflow_dispatch (not PR)

Permissions:

id-token: write

contents: read

Steps:

google-github-actions/auth@v2 with:

workload_identity_provider

service_account

google-github-actions/setup-gcloud@v2 (optional but useful for debugging)

Run:

cargo test -p secrets-provider-gcp-sm --features integration -- --ignored --nocapture

Env:

GCP_PROJECT_ID from repo secret/var

GREENTIC_TEST_PREFIX=ci/gcp/${{ github.run_id }}/${{ github.run_attempt }}

C) Naming & resource model

GCP Secret Manager has:

secret resource + versions
Your contract should map:

put → create secret if missing + add version (or update by adding new version)

get → access latest version

delete → delete secret resource

Ensure cleanup deletes the secret resource.

Docs

Add docs/ci/gcp-wif.md describing:

Workload Identity Pool + Provider trusting GitHub

Service account binding

Minimal roles:

roles/secretmanager.admin (too broad) OR better:

secretmanager.secrets.create

secretmanager.secrets.delete

secretmanager.secrets.get

secretmanager.versions.add

secretmanager.versions.access
(Codex should propose the least privilege it can, and document it.)

Acceptance criteria

gcp_real job passes nightly/manual

No static GCP keys stored
